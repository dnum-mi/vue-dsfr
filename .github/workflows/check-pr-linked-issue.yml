name: Check PR linked to issue

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
  # Relancer quand une issue est ferm√©e/ouverte (peut affecter les liaisons)
  issues:
    types: [opened, closed, reopened]

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest
    # Exception : les PR de develop vers main n'ont pas besoin d'√™tre li√©es √† une issue
    if: (github.event_name == 'pull_request' && (github.head_ref != 'develop' || github.base_ref != 'main')) || github.event_name == 'issues'
    steps:
      - name: Check if PR is linked to an issue
        uses: actions/github-script@v7
        with:
          script: |
            let pullRequests = [];

            if (context.eventName === 'issues') {
              // Si l'√©v√©nement vient d'une issue, v√©rifier toutes les PR ouvertes
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              pullRequests = prs.filter(pr => pr.head.ref !== 'develop' || pr.base.ref !== 'main');
            } else {
              // √âv√©nement normal de PR
              const { data: pullRequest } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              pullRequests = [pullRequest];
            }

            for (const pullRequest of pullRequests) {
              console.log(`üîç V√©rification de la PR #${pullRequest.number}: ${pullRequest.title}`);

              // V√©rifier les issues li√©es via l'interface GitHub avec GraphQL
              const query = `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    pullRequest(number: $number) {
                      closingIssuesReferences(first: 50) {
                        nodes {
                          number
                          title
                        }
                      }
                    }
                  }
                }
              `;

              let linkedIssuesFromUI = [];
              try {
                const result = await github.graphql(query, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: pullRequest.number,
                });
                linkedIssuesFromUI = result.repository.pullRequest.closingIssuesReferences.nodes;
              } catch (error) {
                console.log('Erreur lors de la r√©cup√©ration des issues li√©es via GraphQL:', error.message);
              }

              // V√©rifier dans le corps de la PR (mots-cl√©s comme "closes #123", "fixes #456")
              const prBody = pullRequest.body || '';
              const prTitle = pullRequest.title || '';

              // Pattern pour d√©tecter les r√©f√©rences aux issues
              const issueKeywords = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?|ref(?:erences?)?|see|relate[sd]?(?:\s+to)?)\s*(?:#(\d+)|https?:\/\/github\.com\/[^\/]+\/[^\/]+\/issues\/(\d+))/gi;

              const bodyMatches = prBody.match(issueKeywords);
              const titleMatches = prTitle.match(issueKeywords);

              // V√©rifier aussi les num√©ros d'issues simples dans le titre (ex: "feat: #123 - nouvelle fonctionnalit√©")
              const simpleIssueRef = /(?:^|\s)#(\d+)(?:\s|$|-)/g;
              const titleIssueRefs = prTitle.match(simpleIssueRef);

              const hasLinkedIssues = linkedIssuesFromUI.length > 0 || bodyMatches || titleMatches || titleIssueRefs;

              if (!hasLinkedIssues) {
                core.setFailed(`‚ùå La PR #${pullRequest.number} doit √™tre li√©e √† une issue. Utilisez des mots-cl√©s comme "closes #123" ou "fixes #456" dans la description, r√©f√©rencez une issue dans le titre avec "#123", ou liez une issue via l'interface GitHub.`);
                break; // Arr√™ter au premier √©chec
              } else {
                console.log(`‚úÖ PR #${pullRequest.number} correctement li√©e √† une ou plusieurs issues`);
                if (linkedIssuesFromUI.length > 0) {
                  console.log('Issues li√©es via l\'interface GitHub:', linkedIssuesFromUI.map(issue => `#${issue.number} - ${issue.title}`));
                }
                if (bodyMatches) console.log('Issues trouv√©es dans le body:', bodyMatches);
                if (titleMatches) console.log('Issues trouv√©es dans le titre:', titleMatches);
                if (titleIssueRefs) console.log('R√©f√©rences d\'issues dans le titre:', titleIssueRefs);
              }
            }
